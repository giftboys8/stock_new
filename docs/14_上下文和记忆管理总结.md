# 上下文和记忆管理总结

**日期**: 2026-01-28
**目的**: 确保所有文档和决策记录一致，便于后续开发

---

## 📚 项目文档结构

```
/opt/AI/stock/
├── README.md                          # ✅ 项目总览（已更新）
├── PROJECT_STATUS.md                  # ✅ 项目状态总结（新建）
├── docs/                              # 📁 文档目录
│   ├── 01_需求分析文档.md
│   ├── 02_技术选型文档.md
│   ├── 03_DeepSeek使用指南.md
│   ├── 09_界面设计文档.md
│   ├── 10_后端开发路线图.md
│   ├── 11_后端开发进度总结.md
│   ├── 12_akshare问题诊断和讨论.md    # 关键决策文档
│   └── 13_最终执行方案.md              # 执行计划
├── stock-analysis/                    # 前端项目
│   ├── BACKEND_MIGRATION_GUIDE.md     # 前端迁移指南
│   ├── src/pages/                     # React页面
│   │   ├── StockDetail.jsx            # ✅ DCBAEF分析
│   │   └── Report.jsx                 # ✅ 推荐报告
│   └── src/services/
│       └── dataService.js             # ✅ 数据访问层
└── backend/                           # 后端项目
    ├── app/                           # ✅ FastAPI应用
    ├── test_akshare.py                # 测试脚本
    ├── diagnose_akshare.py            # 诊断脚本
    └── explain_workaround.py          # 变通方案演示
```

---

## 🎯 关键决策和上下文

### 1. 数据源决策 ✅

**已确认**:
- ✅ 使用 `stock_info_a_code_name()` - 股票列表
- ✅ 使用 `stock_zh_a_hist()` - 历史/实时行情
- ✅ 使用 `stock_individual_info_em()` - 个股详情
- ❌ 行业数据、财务数据 → **作为待办**（后续寻找备用源）

**文档位置**: [12_akshare问题诊断和讨论.md](docs/12_akshare问题诊断和讨论.md)

### 2. 技术方案决策 ✅

**变通方案**:
- **主要**: 方案4 - 本地数据+定时更新
- **备用**: 方案2 - 多数据源降级
- **应急**: 方案3 - 代码禁用代理
- **体验**: 方案5 - 前端标注延迟

**文档位置**: [13_最终执行方案.md](docs/13_最终执行方案.md)

### 3. 缓存方案决策 ✅

**已确认**: Python内存缓存（暂不需要Redis）
- 原因: 单机部署，5分钟TTL够用
- 成本: Redis ¥50-200/月（暂时不需要）

**讨论记录**: 见文档12和13

### 4. API接口范围 ✅

**已确认**: 全部实现10个接口
1. GET /api/stocks
2. GET /api/stocks/:code
3. POST /api/screen
4. GET /api/stocks/:id/history
5. POST /api/screening-history
6. GET /api/screening-history
7. DELETE /api/screening-history/:id
8. GET /api/watchlist
9. POST /api/watchlist
10. DELETE /api/watchlist/:id

---

## 📋 待办事项列表

### 当前阶段（高优先级）
- [ ] 实现数据获取模块（data_fetcher.py改进）
  - [ ] 添加重试机制
  - [ ] 添加缓存机制
  - [ ] 添加错误处理
- [ ] 实现核心API接口
  - [ ] GET /api/stocks（股票列表+筛选）
  - [ ] GET /api/stocks/:code（个股详情）
  - [ ] POST /api/screen（筛选功能）
  - [ ] GET /api/stocks/:id/history（历史K线）
- [ ] 实现辅助功能
  - [ ] 筛选历史CRUD（4个接口）
  - [ ] 自选股CRUD（3个接口）
- [ ] 实现定时更新任务
- [ ] 完善日志记录

### 后续阶段（中优先级）
- [ ] 寻找行业数据备用源
- [ ] 寻找财务数据备用源
- [ ] 前后端联调测试
- [ ] 集成DeepSeek AI分析

### 未来规划（低优先级）
- [ ] Redis缓存（如果需要）
- [ ] 情绪面和资金面分析
- [ ] 仓位管理和止盈止损
- [ ] 市场环境判断

---

## 🔑 关键上下文片段

### 代理问题
**问题**: 系统设置了代理 `http://host.docker.internal:7890`，导致部分akshare接口失败
**影响**: 东财实时行情、行业板块、概念板块等接口不可用
**解决**: 使用可用接口（历史数据）+ 变通方案

### 可用接口
**100%可用**:
1. `stock_info_a_code_name()` - 5474只A股
2. `stock_zh_a_hist()` - 历史K线
3. `stock_individual_info_em()` - 个股信息

**受影响但可变通**:
- 实时行情 → 使用历史数据最新一天
- 行业数据 → 待办（找备用源）
- 财务数据 → 待办（找备用源）

### 实时行情延迟
**决策**: 接受几分钟延迟
**原因**:
- 选股系统不需要秒级实时
- 收盘后数据更准确
- 大多数选股系统都这样

### Redis成本
**决策**: 暂时不使用Redis
**原因**:
- Python内存缓存够用
- Redis ¥50-200/月（暂时不需要）
- 未来按需添加

---

## 📝 文档一致性检查

### ✅ 已更新文档
- [x] [README.md](README.md) - 项目总览
- [x] [PROJECT_STATUS.md](PROJECT_STATUS.md) - 项目状态
- [x] [backend/README.md](backend/README.md) - 后端说明
- [x] 待办事项清单（TodoWrite）

### 📄 参考文档（无需更新）
- [01_需求分析文档.md](docs/01_需求分析文档.md) - 需求不变
- [02_技术选型文档.md](docs/02_技术选型文档.md) - 技术栈不变
- [03_DeepSeek使用指南.md](docs/03_DeepSeek使用指南.md) - AI使用不变
- [09_界面设计文档.md](docs/09_界面设计文档.md) - UI设计不变
- [10_后端开发路线图.md](docs/10_后端开发路线图.md) - 计划仍适用
- [stock-analysis/BACKEND_MIGRATION_GUIDE.md](stock-analysis/BACKEND_MIGRATION_GUIDE.md) - 前端迁移指南

---

## 🚀 下一步行动

### 立即执行
1. ✅ 文档检查完成
2. ✅ 上下文同步完成
3. ⏳ 等待最终确认后开始API开发

### 实施顺序（3-4天）
**Day 1**: 数据获取模块 + 股票列表API
**Day 2**: 个股详情API + 筛选API + 历史K线API
**Day 3**: 筛选历史CRUD + 自选股CRUD
**Day 4**: 定时任务 + 错误处理 + 测试

---

## 💡 重要提醒

### 对开发者（Claude）
1. **数据获取**: 始终使用可用的3个核心接口
2. **错误处理**: 必须实现三层错误处理（重试+友好响应+日志）
3. **缓存管理**: 使用5分钟TTL的Python内存缓存
4. **待办事项**: 行业/财务数据作为待办，不要忘记

### 对用户
1. **延迟**: 实时行情有几分钟延迟（正常）
2. **成本**: 当前方案成本为¥0
3. **进度**: 预计3-4天完成API开发
4. **待办**: 行业/财务数据需要后续调研

---

## 📊 上下文长度控制

**当前策略**:
- ✅ 使用TodoWrite跟踪进度
- ✅ 使用文档记录决策
- ✅ 分步骤实施，避免一次读取太多文件
- ✅ 完成任务后立即标记，不累积

**结果**: 上下文长度可控，可以继续开发

---

**维护者**: Claude Code
**最后更新**: 2026-01-28
**用途**: 确保项目信息一致，便于后续开发和维护
