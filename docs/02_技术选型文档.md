# 股票分析系统 - 技术选型文档

## 一、技术栈概览

```
前端层：        HTML + CSS + JavaScript（静态页面）
后端层：        Python（FastAPI）
AI层：          Deep Seek-V3（主力）
数据层：        akshare（行情）+ 爬虫（新闻）
部署：          本地运行（或云服务器）
```

---

## 二、AI模型选型

### 2.1 主模型：Deep Seek-V3

#### 基本信息
- **提供商**：深度求索（Deep Seek）
- **官网**：https://www.deepseek.com/
- **API地址**：https://platform.deepseek.com/
- **上下文长度**：128K tokens
- **价格**（参考）：
  - 输入：¥1 / 1M tokens
  - 输出：¥2 / 1M tokens

#### 使用场景
| 任务 | 使用频率 | 说明 |
|------|---------|------|
| 新闻情感分析 | 高 | 每条新闻都要分析 |
| 事件影响评估 | 高 | 评估对股价的影响 |
| 行业对比分析 | 中 | 对比同行业公司 |
| 生成推荐报告 | 高 | 简洁版+详细版 |
| 技术面解读 | 中 | 解释技术指标 |

#### API调用示例
```python
import requests

def call_deepseek(prompt):
    url = "https://api.deepseek.com/v1/chat/completions"
    headers = {
        "Authorization": "Bearer YOUR_API_KEY",
        "Content-Type": "application/json"
    }
    data = {
        "model": "deepseek-chat",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    response = requests.post(url, headers=headers, json=data)
    return response.json()
```

---

### 2.2 备选模型

#### Qwen-Max（通义千问）
- **提供商**：阿里云
- **官网**：https://tongyi.aliyun.com/
- **优势**：中文能力强，有免费额度
- **价格**：
  - 免费额度：100万tokens/月
  - 超出后：¥0.02 / 1K tokens

**适用场景**：
- Deep Seek的备用方案
- 如果有阿里云账号，可以顺便用

---

#### GLM-4（智谱AI）
- **提供商**：智谱AI
- **官网**：https://open.bigmodel.cn/
- **优势**：国产大模型，性能稳定
- **价格**：
  - 免费：GLM-4-Flash
  - 付费：GLM-4（¥0.1 / 1K tokens）

**适用场景**：
- 简单的文本分类任务
- 新闻情感判断（可省成本）

---

### 2.3 模型使用策略

```
┌──────────────────────────────────────┐
│  任务分类                             │
├──────────────────────────────────────┤
│  复杂推理 → Deep Seek-V3（主力）      │
│  代码生成 → GPT-4 / Claude（国外模型） │
│  简单分类 → GLM-4-Flash（免费）       │
│  备用方案 → Qwen-Max                  │
└──────────────────────────────────────┘
```

**模型分工说明**：

| 任务类型 | 使用模型 | 原因 |
|---------|---------|------|
| **新闻情感分析** | Deep Seek-V3 | 中文理解好，成本低 |
| **事件影响分析** | Deep Seek-V3 | 需要复杂推理 |
| **生成推荐报告** | Deep Seek-V3 | 中文生成能力强 |
| **代码编写** | GPT-4 / Claude / Gemini | 用户已有国外模型访问权限，代码质量更好 |
| **简单分类** | GLM-4-Flash | 免费，节省成本 |

**关于代码生成**：
- 用户已有国外模型（GPT/Claude/Gemini）的访问权限
- 开发过程中写Python代码，优先使用国外模型
- Deep Seek主要用于运行时的AI推理任务

**成本控制建议**：
- 简单任务（情感判断）：用GLM-4-Flash（免费）
- 复杂任务（生成报告）：用Deep Seek-V3
- 月成本预估：¥20-50（个人使用）

---

## 三、数据源选型

### 3.1 行情数据

#### akshare（主力）
- **官网**：https://akshare.akfamily.xyz/
- **类型**：免费开源Python库
- **数据覆盖**：
  - A股：全部股票（实时、日线、周线、月线）
  - 财务数据：季报、年报
  - 宏观数据：GDP、CPI等
  - 行业数据：行业分类、行业指数

**优势**：
- ✅ 完全免费
- ✅ 数据全面
- ✅ 更新及时
- ✅ 文档详细（中文）

**安装**：
```bash
pip install akshare
```

**使用示例**：
```python
import akshare as ak

# 获取股票列表
stock_list = ak.stock_info_a_code_name()

# 获取某只股票的日K线
df = ak.stock_zh_a_hist(symbol="000001", period="daily")

# 获取财务数据
financial_data = ak.stock_financial_analysis(symbol="000001")
```

---

#### tushare（备选）
- **官网**：https://tushare.pro/
- **类型**：免费+付费
- **数据覆盖**：和akshare类似

**优势**：
- 数据质量高
- 有积分系统（可兑换付费数据）

**注意**：需要注册账号，有免费额度限制

---

### 3.2 新闻/公告数据

#### 数据源列表

| 数据源 | URL | 内容 | 获取方式 |
|-------|-----|------|---------|
| **东方财富网** | https://www.eastmoney.com/ | 公司公告、新闻 | 爬虫 |
| **财联社** | https://www.cls.cn/ | 快讯、政策 | 爬虫 |
| **巨潮资讯** | http://www.cninfo.com.cn/ | 官方公告 | 爬虫 |
| **雪球** | https://xueqiu.com/ | 投资者讨论 | 爬虫 |

**技术方案**：
```python
import requests
from bs4 import BeautifulSoup

def get_stock_news(stock_code):
    """爬取某只股票的最新新闻"""
    url = f"https://www.eastmoney.com/{stock_code}.html"
    response = requests.get(url)
    soup = BeautifulSoup(response.text, 'html.parser')

    news_list = []
    for item in soup.select('.news-item'):
        title = item.select_one('.title').text
        url = item.select_one('a')['href']
        news_list.append({'title': title, 'url': url})

    return news_list
```

**注意**：
- 遵守robots.txt
- 设置合理的请求间隔（避免被封）
- 仅用于个人学习

---

### 3.3 财务数据

#### 数据源

| 数据源 | 覆盖范围 | 更新频率 | 推荐度 |
|-------|---------|---------|--------|
| **akshare** | 全部A股 | 季度 | ⭐⭐⭐⭐⭐ |
| **tushare** | 全部A股 | 季度 | ⭐⭐⭐⭐ |

**关键指标**：
- 资产负债表
- 利润表
- 现金流量表
- 财务比率（ROE、毛利率等）

---

## 四、技术工具栈

### 4.1 后端开发

#### Python框架

| 框架 | 推荐度 | 说明 |
|------|--------|------|
| **FastAPI** | ⭐⭐⭐⭐⭐ | 现代化，高性能，自动生成API文档 |
| **Flask** | ⭐⭐⭐⭐ | 轻量级，适合个人项目 |
| **Django** | ⭐⭐⭐ | 功能强大，但较重 |

**推荐**：FastAPI

**选择理由**：
- ✅ 现代化，性能优秀
- ✅ 自动生成OpenAPI文档（访问 /docs 即可查看）
- ✅ 原生支持异步（适合调用AI API）
- ✅ 类型提示友好（代码更易维护）
- ✅ 与前端对接方便

**示例**：
```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class StockRequest(BaseModel):
    code: str
    analysis_type: str = "full"

@app.get('/api/stock/{code}')
async def get_stock_analysis(code: str):
    """获取股票分析报告"""
    # 调用筛选逻辑
    result = analyze_stock(code)
    return result

@app.post('/api/analyze')
async def analyze_multiple_stocks(request: StockRequest):
    """批量分析股票"""
    result = await analyze_stocks_async(request.code)
    return result
```

**启动服务**：
```bash
# 启动后自动访问：http://localhost:8000/docs 查看API文档
uvicorn main:app --reload
```

---

### 4.2 数据处理

#### 核心库

| 库 | 用途 | 安装 |
|----|------|------|
| **pandas** | 数据处理 | `pip install pandas` |
| **numpy** | 数值计算 | `pip install numpy` |
| **TA-Lib** | 技术指标 | `pip install TA-Lib` |
| **mplfinance** | K线图绘制 | `pip install mplfinance` |

**TA-Lib使用示例**：
```python
import talib

# 计算MA20
df['MA20'] = talib.MA(df['close'], timeperiod=20)

# 计算MACD
df['MACD'], df['SIGNAL'], df['HIST'] = talib.MACD(df['close'])

# 计算RSI
df['RSI'] = talib.RSI(df['close'], timeperiod=14)
```

---

### 4.3 数据可视化

#### 图表库

| 库 | 用途 | 推荐度 |
|----|------|--------|
| **matplotlib** | 基础图表 | ⭐⭐⭐⭐⭐ |
| **mplfinance** | K线图 | ⭐⭐⭐⭐⭐ |
| **plotly** | 交互式图表 | ⭐⭐⭐⭐ |
| **echarts** | Web展示 | ⭐⭐⭐⭐ |

**mplfinance示例**：
```python
import mplfinance as mpf

# 绘制K线图
mpf.plot(df, type='candle', mav=(5, 10, 20), volume=True)
```

---

### 4.4 数据库（可选）

| 数据库 | 用途 | 推荐度 |
|-------|------|--------|
| **SQLite** | 本地存储 | ⭐⭐⭐⭐⭐ |
| **MySQL** | 云端部署 | ⭐⭐⭐⭐ |
| **PostgreSQL** | 大规模数据 | ⭐⭐⭐ |

**推荐**：
- 个人使用：SQLite（无需安装，文件型数据库）
- 多人使用：MySQL

**SQLite示例**：
```python
import sqlite3

# 创建数据库
conn = sqlite3.connect('stock_analysis.db')
cursor = conn.cursor()

# 创建表
cursor.execute('''
    CREATE TABLE IF NOT EXISTS stocks (
        code TEXT PRIMARY KEY,
        name TEXT,
        pe REAL,
        roe REAL,
        analysis_date TEXT
    )
''')

# 插入数据
cursor.execute('INSERT INTO stocks VALUES (?, ?, ?, ?, ?)',
               ('000001', '平安银行', 5.2, 0.12, '2026-01-27'))
conn.commit()
```

---

### 4.5 定时任务

#### APScheduler

**用途**：定时更新数据

**安装**：
```bash
pip install apscheduler
```

**示例**：
```python
from apscheduler.schedulers.blocking import BlockingScheduler

def update_stock_data():
    """每天收盘后更新数据"""
    print("更新数据...")
    # 你的更新逻辑

scheduler = BlockingScheduler()
scheduler.add_job(update_stock_data, 'cron', hour=15, minute=30)
scheduler.start()
```

---

## 五、系统架构图

### 5.1 当前实现状态（2026-01-28）

```
┌─────────────────────────────────────────────────┐
│         前端展示层（React 18）                    │
│  ├─ ✅ 选股配置页（Screening.jsx）               │
│  ├─ ✅ 选股结果页（StockResults.jsx）            │
│  ├─ ✅ 历史记录页（History.jsx）                 │
│  ├─ ✅ 历史详情页（HistoryDetail.jsx）           │
│  ├─ ⏳ 个股详情页（StockDetail.jsx 待开发）       │
│  └─ ⏳ AI推荐报告页（Report.jsx 待开发）         │
├─────────────────────────────────────────────────┤
│         样式系统（Tailwind CSS）                  │
│  ├─ 中国风主题（墨色、朱砂红、竹青）              │
│  ├─ 日间/夜间模式切换                            │
│  └─ 装饰组件（山水、飞鸟、星空、雁阵）            │
├─────────────────────────────────────────────────┤
│         数据访问层（DataService）                 │
│  ├─ 统一数据接口封装                             │
│  ├─ 20+个TODO标记（待后端迁移）                  │
│  └─ 清晰的迁移路径设计                           │
├─────────────────────────────────────────────────┤
│         临时数据存储（浏览器）                    │
│  ├─ localStorage：筛选历史、自选股               │
│  ├─ sessionStorage：筛选条件                     │
│  └─ Mock Data：10只股票的硬编码数据              │
└─────────────────────────────────────────────────┘

正在迁移到 ↓

┌─────────────────────────────────────────────────┐
│         后端服务层（FastAPI - 待开发）            │
│  ├─ 数据获取（akshare）                          │
│  ├─ 选股引擎（3套策略）                          │
│  ├─ 分析引擎（DCBAEF六维度）                     │
│  └─ RESTful API                                 │
├─────────────────────────────────────────────────┤
│         数据处理层（Python）                      │
│  ├─ 技术分析（TA-Lib）                           │
│  ├─ 数据清洗（pandas）                           │
│  └─ 定时任务（APScheduler）                      │
├─────────────────────────────────────────────────┤
│         AI推理层（Deep Seek-V3）                 │
│  ├─ 新闻情感分析                                 │
│  ├─ 事件影响评估                                 │
│  └─ 推荐报告生成                                 │
├─────────────────────────────────────────────────┤
│         数据存储层                               │
│  ├─ 开发环境：SQLite                            │
│  ├─ 生产环境：PostgreSQL                        │
│  └─ 缓存层：Redis（可选）                        │
└─────────────────────────────────────────────────┘
```

### 5.2 原始架构设计（已调整）

**技术决策调整说明**：

1. **前端框架调整**：
   - 原计划：HTML静态页面 + JavaScript
   - 实际实现：React 18 + React Router + Tailwind CSS
   - 调整原因：React提供更好的组件复用、状态管理和路由控制

2. **数据存储分阶段方案**：
   - 原计划：直接使用后端数据库
   - 实际实现：先使用localStorage验证前端，再迁移到后端
   - 调整原因：降低初期开发成本，快速验证功能设计

3. **完整架构设计**（与原始计划一致）：

```
┌─────────────────────────────────────────────────┐
│         用户界面（React + Tailwind CSS）          │
│  ├─ 漏斗选股页                                   │
│  ├─ 个股分析页                                   │
│  └─ AI报告页                                     │
├─────────────────────────────────────────────────┤
│         后端服务层（FastAPI）                     │
│  ├─ 选股引擎                                     │
│  ├─ 分析引擎                                     │
│  └─ AI调度模块                                   │
├─────────────────────────────────────────────────┤
│         数据处理层（Python）                      │
│  ├─ 数据获取（akshare）                          │
│  ├─ 技术分析（TA-Lib）                           │
│  └─ 新闻爬虫（requests）                         │
├─────────────────────────────────────────────────┤
│         AI推理层（Deep Seek）                     │
│  ├─ 情感分析                                     │
│  ├─ 影响评估                                     │
│  └─ 报告生成                                     │
├─────────────────────────────────────────────────┤
│         数据存储层（SQLite → PostgreSQL）         │
│  ├─ 股票基础数据                                 │
│  ├─ 财务数据                                     │
│  └─ 分析历史                                     │
└─────────────────────────────────────────────────┘
```

---

## 六、开发环境

### 6.1 Python版本
- **推荐**：Python 3.9+
- **原因**：库支持好

### 6.2 必要的库

**安装命令**：
```bash
# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 安装依赖
pip install akshare pandas numpy talib mplfinance fastapi uvicorn requests beautifulsoup4 apscheduler
```

---

## 七、部署方案

### 7.1 本地运行（推荐）
- **优势**：完全免费，数据安全
- **适用**：个人使用

### 7.2 云服务器（可选）
- **推荐**：阿里云、腾讯云
- **配置**：2核4G即可
- **成本**：约¥100/月

---

## 八、成本估算

### 8.1 开发成本
- 开发时间：1-2周（个人开发）
- 无金钱成本（全用免费工具）

### 8.2 运营成本（每月）
| 项目 | 成本 |
|------|------|
| AI API（Deep Seek） | ¥20-50 |
| 云服务器（可选） | ¥0-100 |
| **合计** | **¥20-150** |

---

## 九、技术风险

| 风险 | 应对方案 |
|------|---------|
| akshare停止服务 | 备用tushare |
| Deep Seek API限流 | 备用Qwen-Max |
| 爬虫被屏蔽 | 更换数据源 |
| 数据质量差 | 多源交叉验证 |

---

## 十、后续优化方向

- [ ] 增加美股、港股支持
- [ ] 增加回测功能
- [ ] 增加量化策略
- [ ] 移动端适配

---

## 十一、技术决策记录（2026-01-28更新）

### 11.1 数据库选型

**决策内容**：
- **开发阶段**：使用SQLite
- **生产环境**：使用PostgreSQL

**理由**：
- SQLite：零配置，文件型数据库，适合本地开发和单用户
- PostgreSQL：功能强大，适合复杂查询，支持云端部署

**迁移策略**：
- 使用SQLAlchemy ORM，数据库无关性设计
- 开发完成后，只需修改连接字符串即可切换

### 11.2 部署方式

**决策内容**：
- **当前阶段**：本地部署
- **未来规划**：Docker容器化 + 可选云部署

**理由**：
- 开发阶段本地运行即可，降低成本
- Docker保证环境一致性，便于部署

**技术栈**：
```dockerfile
# Dockerfile 示例
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 11.3 数据更新策略（重要）

#### 当前需求：小时级更新

**实现方案**：
```python
from apscheduler.schedulers.blocking import BlockingScheduler

def update_stock_data():
    """每小时更新一次股票数据"""
    print(f"[{datetime.now()}] 开始更新股票数据...")
    # 1. 获取股票列表
    # 2. 更新实时行情
    # 3. 更新财务数据
    # 4. 保存到数据库
    print("数据更新完成")

scheduler = BlockingScheduler()
# 小时级更新
scheduler.add_job(update_stock_data, 'interval', hours=1)
scheduler.start()
```

#### 未来扩展：分钟级更新（预留能力）

**必要性分析**：

| 更新频率 | 适用场景 | 成本 | 技术难度 |
|---------|---------|------|---------|
| **小时级** | 个人投资，中长期持有 | 低 | ⭐⭐ |
| **30分钟级** | 日内交易，短线操作 | 中 | ⭐⭐⭐ |
| **分钟级（1-5分钟）** | 高频交易，实时监控 | 高 | ⭐⭐⭐⭐ |
| **实时（秒级）** | 程序化交易，套利 | 很高 | ⭐⭐⭐⭐⭐ |

**分钟级更新的挑战**：
1. **API限流**：akshare免费版可能有请求频率限制
2. **数据量**：更新频率提高10倍，数据存储压力增大
3. **系统负载**：数据库写入频繁，性能优化要求高
4. **成本增加**：可能需要购买付费数据源

**兼容性设计**（如何支持分钟级）：

```python
# 配置文件（config.py）
UPDATE_INTERVAL_MINUTES = int(os.getenv('UPDATE_INTERVAL', '60'))  # 默认60分钟

# 调度器配置
scheduler.add_job(
    update_stock_data,
    'interval',
    minutes=UPDATE_INTERVAL_MINUTES  # 可配置：60, 30, 10, 5, 1
)
```

**升级路径**：
```
阶段1（当前）：60分钟更新
    ↓ 修改配置文件
阶段2（可选）：30分钟更新
    ↓ 优化数据库索引 + Redis缓存
阶段3（可选）：5-10分钟更新
    ↓ 购买付费数据源 + 异步队列
阶段4（高级）：1-5分钟更新
    ↓ 分布式架构 + 消息队列
```

**建议**：
- **当前阶段**：小时级更新完全满足需求
- **验证后**：如果需要更实时，先尝试30分钟
- **避免过度设计**：不要一开始就按分钟级设计

### 11.4 开发优先级

**决策内容**：先补全前端，再做后端

**实施顺序**：
1. **阶段1**（1周）：补全前端页面
   - 个股详情页面（StockDetail.jsx）
   - AI推荐报告页面（Report.jsx）
   - DCBAEF六维度分析展示

2. **阶段2**（3-4周）：后端开发
   - Python FastAPI项目搭建
   - akshare数据获取模块
   - RESTful API接口实现
   - 数据库设计和实现

3. **阶段3**（1-2周）：前后端集成和测试
   - 替换DataService中的方法
   - 完整功能测试
   - 性能优化

**理由**：
- 前端功能完整后，更容易验证整体流程
- 使用mock数据可以快速迭代UI
- 用户可以先体验完整功能，再决定是否需要后端

---

**文档更新日期**：2026-01-28
**文档版本**：v2.0（补充前端实现和技术决策记录）
**下一步**：创建后端开发路线图文档
