/**
 * 数据服务层 - 统一数据访问接口
 *
 * TODO: 未来迁移到后端时，只需修改这个文件中的方法实现
 * 将 localStorage 操作替换为 API 调用即可
 *
 * 迁移计划：
 * 1. getStocks() -> GET /api/stocks
 * 2. getStockById(id) -> GET /api/stocks/:id
 * 3. saveScreeningHistory(record) -> POST /api/screening-history
 * 4. getScreeningHistory() -> GET /api/screening-history
 * 5. deleteScreeningHistory(id) -> DELETE /api/screening-history/:id
 * 6. clearScreeningHistory() -> DELETE /api/screening-history
 */

class DataService {
  // ==================== 股票数据相关 ====================

  /**
   * 获取所有股票数据
   * TODO: 后端迁移 -> GET /api/stocks?criteria={...}
   */
  static getStocks(criteria = {}) {
    // TODO: 未来需要实现服务端筛选
    // 现在在前端进行筛选，未来应该将 criteria 传给后端
    const allStocks = this._getMockStockData();

    // 如果有筛选条件，在前端进行筛选
    if (Object.keys(criteria).length > 0) {
      return this._filterStocks(allStocks, criteria);
    }

    return allStocks;
  }

  /**
   * 根据ID获取股票详情
   * TODO: 后端迁移 -> GET /api/stocks/:id
   */
  static getStockById(id) {
    const allStocks = this._getMockStockData();
    return allStocks.find(stock => stock.id === parseInt(id));
  }

  // ==================== 历史记录相关 ====================

  /**
   * 保存筛选历史记录
   * TODO: 后端迁移 -> POST /api/screening-history
   *
   * @param {Object} record - 筛选记录
   * @param {Object} record.criteria - 筛选条件
   * @param {Array} record.results - 筛选结果（只保存前10条）
   * @param {Number} record.resultCount - 结果总数
   * @param {Number} record.avgChange - 平均涨幅
   */
  static saveScreeningHistory(record) {
    try {
      const history = this.getScreeningHistory();
      const newRecord = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        ...record
      };

      // 添加到历史记录开头
      history.unshift(newRecord);

      // 只保留最近 100 条记录
      // TODO: 未来在后端可以无限存储，或者由用户设置保留数量
      const limitedHistory = history.slice(0, 100);

      localStorage.setItem('screeningHistory', JSON.stringify(limitedHistory));
      return newRecord;
    } catch (error) {
      console.error('保存筛选历史失败:', error);
      throw error;
    }
  }

  /**
   * 获取筛选历史记录
   * TODO: 后端迁移 -> GET /api/screening-history?limit=100&offset=0
   *
   * @param {Object} options - 查询选项
   * @param {Number} options.limit - 返回数量限制
   * @param {Number} options.offset - 偏移量（用于分页）
   */
  static getScreeningHistory(options = {}) {
    try {
      const historyData = localStorage.getItem('screeningHistory');
      let history = historyData ? JSON.parse(historyData) : [];

      // TODO: 未来在后端实现分页
      const { limit, offset = 0 } = options;
      if (limit) {
        history = history.slice(offset, offset + limit);
      }

      return history;
    } catch (error) {
      console.error('读取筛选历史失败:', error);
      return [];
    }
  }

  /**
   * 根据ID获取单条历史记录
   * TODO: 后端迁移 -> GET /api/screening-history/:id
   */
  static getScreeningHistoryById(id) {
    const history = this.getScreeningHistory();
    return history.find(record => record.id === parseInt(id));
  }

  /**
   * 删除单条历史记录
   * TODO: 后端迁移 -> DELETE /api/screening-history/:id
   */
  static deleteScreeningHistory(id) {
    try {
      const history = this.getScreeningHistory();
      const filteredHistory = history.filter(record => record.id !== parseInt(id));
      localStorage.setItem('screeningHistory', JSON.stringify(filteredHistory));
      return true;
    } catch (error) {
      console.error('删除筛选历史失败:', error);
      return false;
    }
  }

  /**
   * 清空所有历史记录
   * TODO: 后端迁移 -> DELETE /api/screening-history
   */
  static clearScreeningHistory() {
    try {
      localStorage.removeItem('screeningHistory');
      return true;
    } catch (error) {
      console.error('清空筛选历史失败:', error);
      return false;
    }
  }

  // ==================== 自选股相关 ====================

  /**
   * 添加自选股
   * TODO: 后端迁移 -> POST /api/watchlist
   */
  static addWatchlist(stockId) {
    try {
      const watchlist = this.getWatchlist();
      if (!watchlist.includes(stockId)) {
        watchlist.push(stockId);
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
      }
      return true;
    } catch (error) {
      console.error('添加自选股失败:', error);
      return false;
    }
  }

  /**
   * 移除自选股
   * TODO: 后端迁移 -> DELETE /api/watchlist/:id
   */
  static removeWatchlist(stockId) {
    try {
      const watchlist = this.getWatchlist();
      const filteredWatchlist = watchlist.filter(id => id !== stockId);
      localStorage.setItem('watchlist', JSON.stringify(filteredWatchlist));
      return true;
    } catch (error) {
      console.error('移除自选股失败:', error);
      return false;
    }
  }

  /**
   * 获取自选股列表
   * TODO: 后端迁移 -> GET /api/watchlist
   */
  static getWatchlist() {
    try {
      const watchlistData = localStorage.getItem('watchlist');
      return watchlistData ? JSON.parse(watchlistData) : [];
    } catch (error) {
      console.error('读取自选股失败:', error);
      return [];
    }
  }

  // ==================== 私有辅助方法 ====================

  /**
   * 根据条件筛选股票
   * TODO: 未来这个逻辑应该在后端实现，前端只负责展示
   */
  static _filterStocks(stocks, criteria) {
    return stocks.filter(stock => {
      // 行业筛选
      if (criteria.industry && criteria.industry !== '全部') {
        if (stock.industry !== criteria.industry) return false;
      }

      // 市盈率筛选
      if (criteria.peMin !== undefined && stock.pe < criteria.peMin) return false;
      if (criteria.peMax !== undefined && stock.pe > criteria.peMax) return false;

      // 市净率筛选
      if (criteria.pbMin !== undefined && stock.pb < criteria.pbMin) return false;
      if (criteria.pbMax !== undefined && stock.pb > criteria.pbMax) return false;

      // 市值筛选
      if (criteria.marketCap) {
        const capValue = this._parseMarketCap(stock.marketCap);
        const minCap = this._parseMarketCap(criteria.marketCap);
        if (capValue < minCap) return false;
      }

      // 涨跌幅筛选
      if (criteria.changeType === 'up' && stock.change <= 0) return false;
      if (criteria.changeType === 'down' && stock.change >= 0) return false;

      return true;
    });
  }

  /**
   * 解析市值字符串为数值（亿）
   */
  static _parseMarketCap(marketCapStr) {
    const match = marketCapStr.match(/([\d.]+)(\w?)/);
    if (!match) return 0;

    const value = parseFloat(match[1]);
    const unit = match[2];

    if (unit === '万亿') return value * 10000;
    if (unit === '亿') return value * 100;
    if (unit === '万') return value / 10000;
    return value;
  }

  /**
   * 获取模拟股票数据
   * TODO: 后端迁移后删除此方法，使用真实 API
   * 这是一个临时的数据源，未来应该从后端 API 获取
   */
  static _getMockStockData() {
    return [
      {
        id: 1,
        code: '600519',
        name: '贵州茅台',
        price: 1856.00,
        change: 2.35,
        volume: '2.56万手',
        pe: 35.6,
        pb: 12.8,
        marketCap: '2.3万亿',
        turnover: '45.6亿',
        high52: 1980.00,
        low52: 1520.00,
        dividend: 25.91,
        dividendYield: 1.4,
        industry: '白酒',
        concept: ['MSCI中国', '沪股通', '机构重仓'],
        description: '贵州茅台是中国著名的白酒品牌，主要生产茅台酒及系列酒。公司是中国白酒行业的龙头企业，拥有独特的地理环境和传统酿造工艺。'
      },
      {
        id: 2,
        code: '000858',
        name: '五粮液',
        price: 168.50,
        change: 1.82,
        volume: '8.32万手',
        pe: 28.5,
        pb: 10.2,
        marketCap: '6500亿',
        turnover: '14.2亿',
        high52: 195.50,
        low52: 135.20,
        dividend: 15.68,
        dividendYield: 0.9,
        industry: '白酒',
        concept: ['MSCI中国', '深股通', '机构重仓'],
        description: '五粮液是中国知名的白酒品牌，以五粮浓香型白酒闻名。公司拥有"五粮液"、"五粮春"等多个品牌。'
      },
      {
        id: 3,
        code: '600036',
        name: '招商银行',
        price: 42.30,
        change: -0.56,
        volume: '15.6万手',
        pe: 8.5,
        pb: 1.2,
        marketCap: '1.1万亿',
        turnover: '6.6亿',
        high52: 48.50,
        low52: 32.80,
        dividend: 1.89,
        dividendYield: 4.5,
        industry: '银行',
        concept: ['MSCI中国', '沪股通', '机构重仓'],
        description: '招商银行是中国第一家完全由企业法人持股的股份制商业银行，以零售银行业务见长。'
      },
      {
        id: 4,
        code: '000001',
        name: '平安银行',
        price: 12.85,
        change: 0.78,
        volume: '22.3万手',
        pe: 6.8,
        pb: 0.85,
        marketCap: '2480亿',
        turnover: '2.9亿',
        high52: 15.20,
        low52: 10.50,
        dividend: 0.52,
        dividendYield: 4.0,
        industry: '银行',
        concept: ['深股通', '机构重仓'],
        description: '平安银行是平安集团旗下重要成员，致力于成为国际领先的个人金融生活服务提供商。'
      },
      {
        id: 5,
        code: '601318',
        name: '中国平安',
        price: 56.20,
        change: 1.25,
        volume: '18.9万手',
        pe: 9.2,
        pb: 1.5,
        marketCap: '1.0万亿',
        turnover: '10.6亿',
        high52: 65.80,
        low52: 42.30,
        dividend: 2.63,
        dividendYield: 4.7,
        industry: '保险',
        concept: ['MSCI中国', '沪股通', '机构重仓'],
        description: '中国平安是中国领先的综合金融服务集团，业务涵盖保险、银行、投资等领域。'
      },
      {
        id: 6,
        code: '000568',
        name: '泸州老窖',
        price: 198.80,
        change: 1.65,
        volume: '5.21万手',
        pe: 32.8,
        pb: 11.5,
        marketCap: '2900亿',
        turnover: '10.4亿',
        high52: 245.60,
        low52: 165.30,
        dividend: 10.24,
        dividendYield: 5.1,
        industry: '白酒',
        concept: ['深股通', '机构重仓'],
        description: '泸州老窖是中国知名的白酒企业，拥有"国窖1573"等知名品牌。'
      },
      {
        id: 7,
        code: '600809',
        name: '山西汾酒',
        price: 245.30,
        change: 2.12,
        volume: '3.45万手',
        pe: 45.6,
        pb: 15.8,
        marketCap: '2100亿',
        turnover: '8.5亿',
        high52: 298.40,
        low52: 185.60,
        dividend: 12.56,
        dividendYield: 5.1,
        industry: '白酒',
        concept: ['沪股通', '机构重仓'],
        description: '山西汾酒是中国白酒行业的知名企业，以清香型白酒著称。'
      },
      {
        id: 8,
        code: '601328',
        name: '工商银行',
        price: 5.12,
        change: 0.35,
        volume: '125.6万手',
        pe: 4.8,
        pb: 0.58,
        marketCap: '1.8万亿',
        turnover: '6.4亿',
        high52: 6.20,
        low52: 4.50,
        dividend: 0.29,
        dividendYield: 5.7,
        industry: '银行',
        concept: ['MSCI中国', '沪股通', '机构重仓'],
        description: '工商银行是中国最大的商业银行之一，拥有广泛的营业网络和客户基础。'
      },
      {
        id: 9,
        code: '000333',
        name: '美的集团',
        price: 68.50,
        change: 1.45,
        volume: '12.8万手',
        pe: 14.2,
        pb: 3.8,
        marketCap: '4800亿',
        turnover: '8.8亿',
        high52: 78.60,
        low52: 52.30,
        dividend: 3.25,
        dividendYield: 4.7,
        industry: '家电',
        concept: ['MSCI中国', '深股通', '机构重仓'],
        description: '美的集团是中国领先的家电企业，产品涵盖空调、冰箱、洗衣机等多个品类。'
      },
      {
        id: 10,
        code: '600276',
        name: '恒瑞医药',
        price: 52.30,
        change: -1.25,
        volume: '8.9万手',
        pe: 55.6,
        pb: 8.9,
        marketCap: '3400亿',
        turnover: '4.7亿',
        high52: 68.40,
        low52: 45.20,
        dividend: 1.56,
        dividendYield: 3.0,
        industry: '医药',
        concept: ['MSCI中国', '沪股通', '机构重仓'],
        description: '恒瑞医药是中国领先的创新药研发企业，专注于抗肿瘤药、手术用药等领域的研发。'
      }
    ];
  }
}

export default DataService;
